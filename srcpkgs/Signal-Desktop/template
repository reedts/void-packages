# Template file for 'Signal-Desktop'
pkgname=Signal-Desktop
version=5.4.1
revision=1
# Due to electron
# 32-bit is not supported https://github.com/signalapp/Signal-Desktop/issues/1661
archs="x86_64"
hostmakedepends="git git-lfs nodejs python3 tar yarn"
depends="libvips"
short_desc="Signal Private Messenger for Linux"
maintainer="Julio Galvan <juliogalvan@protonmail.com>"
license="AGPL-3.0-only"
homepage="https://github.com/signalapp/Signal-Desktop"
distfiles="https://github.com/signalapp/Signal-Desktop/archive/v${version}.tar.gz"
checksum=60c3772c5951d95469e2ab491b2f09d7ee93c998909de8cb169e23b461b7ebbc
nostrip_files="signal-desktop"

post_extract() {
	# git-lfs hook needs to be installed for one of the dependencies
	git lfs install

	vsed 's/"node": "/&>=/' -i package.json

	yarn install --ignore-engines
}

do_build() {
	yarn generate
	yarn build-release
}

do_install() {
	vmkdir usr/lib/signal-desktop

	rm -rf release/linux-unpacked/resources/app.asar.unpacked/node_modules/ffi-napi/prebuilds/{darwin-x64,linux-arm64,win32-ia32,win32-x64}
	rm -rf release/linux-unpacked/resources/app.asar.unpacked/node_modules/ref-napi/prebuilds/{darwin-x64,linux-arm64,win32-ia32,win32-x64}
	vcopy release/linux-unpacked/* usr/lib/signal-desktop

	vmkdir usr/bin
	ln -s /usr/lib/signal-desktop/signal-desktop ${DESTDIR}/usr/bin/

	vmkdir usr/share/applications
	vinstall ${FILESDIR}/signal.desktop 644 usr/share/applications/

	vmkdir usr/share/icons/hicolor
	for size in 16 32 48 128 256 1024; do
		vinstall images/icon_${size}.png 644 usr/share/icons/hicolor/${size}x${size}/apps/ signal.png
	done

	vlicense LICENSE
}
